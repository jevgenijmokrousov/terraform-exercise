version: 2

jobs:
  terraform-plan:
    working_directory: ~/app
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - run:
          name: Terrraform `init -> plan`
          command: |
            cd ../
            terraform init -input=false -upgrade
            terraform plan -input=false
      - persist_to_workspace:
          root: .
          paths:
            - .
          
  terraform-apply:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Terrraform `apply`
          command: |
            terraform apply -input=false -auto-approve
      - persist_to_workspace:
          root: .
          paths:
            - .
          
  terraform-destroy:
    docker:
      - image: docker.mirror.hashicorp.services/hashicorp/terraform:light
    steps:
      - attach_workspace:
          at: .
      - run:
          name: Terraform `destroy`
          command: terraform apply -destroy
      - persist_to_workspace:
          root: .
          paths:
            - .
          
workflows:
  version: 2
  terraform:
    jobs:
      - terraform-plan
      - terraform-apply:
          requires:
            - terraform-plan
      - terraform-hold-destroy:
          type: approval
      - terraform-destroy:
          requires:
            - terraform-hold-destroy
